<!-- カレンダーコンポーネント -->
<!-- パラメータ: 
  - calendar_data: カレンダーデータ
  - user_dates: ユーザーの予定がある日付リスト
  - user_locations: ユーザーの勤務場所マップ
  - location_styles: 勤務場所別のスタイル
  - editable: 編集可能かどうか (true/false)
  - user_id: ユーザーID（編集時に必要）
  - month_name: 月名表示（タイトル用）
  - location_types: 勤務場所の種類リスト（編集時に必要）
  - prev_month: 前月情報 (YYYY-MM形式)
  - next_month: 翌月情報 (YYYY-MM形式)
-->

{# ビューに応じて編集可能かどうかを設定 #} {% set editable = editable|default(False) %}

<section class="p-2">
  <!-- カレンダータイトル -->
  <h3 class="text-xl font-bold text-center mb-5 text-base-content">{{ month_name }}</h3>

  <!-- デバッグ情報（非表示） -->
  <div
    id="calendar-debug-info"
    style="display: none"
    data-month-name="{{ month_name }}"
    data-prev-month="{{ prev_month }}"
    data-next-month="{{ next_month }}"
    data-user-id="{{ user_id }}"
    data-user-dates-count="{{ user_dates|length }}"
  ></div>

  <!-- テーブル形式のカレンダー -->
  <div class="overflow-x-auto">
    <table class="table table-xs w-full" style="table-layout: fixed">
      <thead>
        <tr>
          <!-- 曜日ヘッダー -->
          <th class="bg-base-200 text-left sticky left-0 z-10 w-28" style="min-width: 140px">日付</th>
          {% set weekdays = ["日", "月", "火", "水", "木", "金", "土"] %} {% for week in calendar_data %} {% for day in
          week %} {% if day and day.day != 0 %} {% set weekday_index = loop.index0 %} {% set is_weekend = weekday_index
          == 0 or weekday_index == 6 %} {% set is_holiday = day.is_holiday|default(false) %} {% set weekend_class =
          "bg-opacity-90 " ~ ("bg-red-900/10 dark:bg-red-300/10" if weekday_index == 0 or is_holiday else
          "bg-blue-900/10 dark:bg-blue-300/10" if weekday_index == 6 else "") %}

          <th
            class="bg-base-200 text-center p-1 calendar-header-cell {% if is_weekend or is_holiday %}{{ weekend_class }}{% endif %}"
            data-date="{{ day.date }}"
            data-day="{{ day.day }}"
            data-is-holiday="{{ is_holiday|lower }}"
            data-holiday-name="{{ day.holiday_name|default('') }}"
          >
            <div
              class="font-bold text-sm {% if is_holiday or weekday_index == 0 %}text-red-600 dark:text-red-400{% elif weekday_index == 6 %}text-blue-600 dark:text-blue-400{% endif %}"
            >
              {{ day.day }}
            </div>
            <div
              class="text-xs opacity-70 {% if day.holiday_name|default('') %}custom-tooltip holiday-tooltip{% endif %}"
            >
              {{ weekdays[weekday_index] }} {% if day.holiday_name|default('') %}
              <span class="tooltip-text">{{ day.holiday_name }}</span>
              {% endif %}
            </div>
          </th>
          {% endif %} {% endfor %} {% endfor %}
        </tr>
      </thead>
      <tbody>
        <!-- 勤務場所ごとの行 -->
        {% if editable %} {% for location_type in location_types %} {% set location_id = loop.index %} {% set
        style_class = location_styles[location_type] if location_type in location_styles else "" %}
        <tr>
          <td
            class="bg-base-200 font-medium text-left sticky left-0 z-10 whitespace-nowrap w-28"
            style="min-width: 140px"
          >
            <span class="{{ style_class }} px-2 py-1 rounded">{{ location_type }}</span>
          </td>

          {% for week in calendar_data %} {% for day in week %} {% if day and day.day != 0 %} {% set weekday_index =
          loop.index0 %} {% set is_weekend = weekday_index == 0 or weekday_index == 6 %} {% set is_holiday =
          day.is_holiday|default(false) %} {% set weekend_class = "bg-opacity-90 " ~ ("bg-red-900/10 dark:bg-red-300/10"
          if weekday_index == 0 or is_holiday else "bg-blue-900/10 dark:bg-blue-300/10" if weekday_index == 6 else "")
          %} {% set has_data = day.date in user_dates %} {% set current_location = user_locations[day.date] if has_data
          else "" %} {% set is_selected = current_location == location_type %}

          <td
            class="text-center hover:bg-base-300 cursor-pointer p-1 calendar-cell {% if is_weekend or is_holiday %}{{ weekend_class }}{% endif %} {% if is_selected %}{{ style_class }}{% endif %}"
            data-date="{{ day.date }}"
            data-location-id="{{ location_id }}"
            data-location-type="{{ location_type }}"
            data-user-id="{{ user_id }}"
            data-is-selected="{{ is_selected|lower }}"
          >
            {% if is_selected %}
            <div class="text-sm location-marker">●</div>
            {% endif %}
          </td>
          {% endif %} {% endfor %} {% endfor %}
        </tr>
        {% endfor %} {% else %}
        <!-- 閲覧専用モード -->
        <tr>
          <td
            class="bg-base-200 font-medium text-left sticky left-0 z-10 whitespace-nowrap w-28"
            style="min-width: 140px"
          >
            勤務場所
          </td>

          {% for week in calendar_data %} {% for day in week %} {% if day and day.day != 0 %} {% set weekday_index =
          loop.index0 %} {% set is_weekend = weekday_index == 0 or weekday_index == 6 %} {% set is_holiday =
          day.is_holiday|default(false) %} {% set weekend_class = "bg-opacity-90 " ~ ("bg-red-900/10 dark:bg-red-300/10"
          if weekday_index == 0 or is_holiday else "bg-blue-900/10 dark:bg-blue-300/10" if weekday_index == 6 else "")
          %} {% set has_data = day.date in user_dates %} {% set location = user_locations[day.date] if has_data else ""
          %} {% set style_class = location_styles[location] if location in location_styles else "" %}

          <td class="text-center p-1 {% if is_weekend or is_holiday %}{{ weekend_class }}{% endif %}">
            {% if has_data %}
            <span class="{{ style_class }}">{{ location }}</span>
            {% endif %}
          </td>
          {% endif %} {% endfor %} {% endfor %}
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<!-- 共通スタイルとスクリプトの読み込み -->
{% if editable %}
<link rel="stylesheet" href="/static/css/calendar.css" />
<script src="/static/js/calendar.js"></script>

<!-- スタイルデータをJSON形式で埋め込み -->
{% if location_styles %}
<div id="location-styles-data" data-styles="{{ location_styles|tojson|safe }}" style="display: none"></div>
{% endif %} {% endif %}
