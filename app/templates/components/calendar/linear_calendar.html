<section class="p-2">
  <h2 class="text-xl font-bold mb-4 text-center">{{ month }}</h2>
  <div class="overflow-x-auto">
    <table class="table table-xs table-zebra w-full" style="table-layout: fixed">
      <thead>
        <tr>
          <th class="bg-base-200 text-left sticky left-0 z-10 w-32" style="width: 130px; min-width: 130px">勤務場所</th>

          {# 日付データを前処理して配列に格納 - パフォーマンス最適化 #} {% set day_data_array = [] %} {% set
          weekday_array = [] %} {% for week in calendar.weeks %} {% for day_idx in range(7) %} {% if week[day_idx] and
          week[day_idx].day != 0 %} {% set day = week[day_idx] %} {% set day_idx_val = day_idx %} {% set is_weekend =
          day_idx == 0 or day_idx == 6 %} {% set is_holiday = day.is_holiday|default(false) %} {% set weekend_class =
          "bg-opacity-90 " ~ ( "bg-red-900/10 dark:bg-red-300/10" if day_idx == 0 or is_holiday else "bg-blue-900/10
          dark:bg-blue-300/10" if day_idx == 6 else "" ) %} {% set _ = day_data_array.append({ 'day': day, 'day_idx':
          day_idx_val, 'is_weekend': is_weekend, 'is_holiday': is_holiday, 'weekend_class': weekend_class }) %} {% endif
          %} {% endfor %} {% endfor %} {# 日付ヘッダーを効率的に出力 #} {% for item in day_data_array %} {% set day =
          item.day %} {% set day_idx = item.day_idx %} {% set is_weekend = item.is_weekend %} {% set is_holiday =
          item.is_holiday %} {% set weekend_class = item.weekend_class %}

          <th
            class="bg-base-200 text-center p-1 w-10 {% if is_weekend or is_holiday %}{{ weekend_class }}{% endif %} calendar-cell"
            hx-get="/day/{{ day.date }}"
            hx-target="#detail-area"
            data-date="{{ day.date }}"
            data-day="{{ day.day }}"
            onclick="highlightSelectedDate('{{ day.date }}')"
            style="width: 20px; min-width: 20px; max-width: 20px"
          >
            <div
              class="font-bold text-sm {% if is_holiday or day_idx == 0 %}text-red-600 dark:text-red-400{% elif day_idx == 6 %}text-blue-600 dark:text-blue-400{% endif %}"
            >
              {{ day.day }}
            </div>
            {% if day.holiday_name|default('') %}
            <div class="text-xs opacity-70 custom-tooltip holiday-tooltip">
              {% set weekdays = ["日", "月", "火", "水", "木", "金", "土"] %} {{ weekdays[day_idx] }}
              <span class="tooltip-text">{{ day.holiday_name }}</span>
            </div>
            {% else %}
            <div class="text-xs opacity-70">
              {% set weekdays = ["日", "月", "火", "水", "木", "金", "土"] %} {{ weekdays[day_idx] }}
            </div>
            {% endif %}
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <!-- 勤務場所の行 -->
        {% for location in calendar.locations %}
        <tr>
          <td
            class="bg-base-200 font-medium text-left sticky left-0 z-10 w-32 whitespace-nowrap"
            style="width: 130px; min-width: 130px"
          >
            {{ location.name }}
          </td>

          {# 各勤務場所のデータを一度のループで効率的に表示 #} {% for item in day_data_array %} {% set day = item.day %}
          {% set day_idx = item.day_idx %} {% set is_weekend = item.is_weekend %} {% set is_holiday = item.is_holiday %}
          {% set weekend_class = item.weekend_class %}

          <td
            class="text-center hover:bg-base-300 cursor-pointer p-1 {% if is_weekend or is_holiday %}{{ weekend_class }}{% endif %} calendar-cell"
            hx-get="/day/{{ day.date }}"
            hx-target="#detail-area"
            data-date="{{ day.date }}"
            data-day="{{ day.day }}"
            onclick="highlightSelectedDate('{{ day.date }}')"
            style="width: 40px; min-width: 40px; max-width: 40px"
          >
            <span class="{{ location.color }} whitespace-nowrap">
              {% if day and location.key in day and day[location.key] != 0 %} {{ day[location.key] }} {% endif %}
            </span>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="flex justify-center mt-4 space-x-2">
    <button
      class="btn btn-sm btn-outline"
      hx-get="/calendar?month={{ calendar.prev_month }}"
      hx-target="#calendar-area"
    >
      ＜前月
    </button>
    <button class="btn btn-sm" hx-get="/calendar" hx-target="#calendar-area">今月</button>
    <button
      class="btn btn-sm btn-outline"
      hx-get="/calendar?month={{ calendar.next_month }}"
      hx-target="#calendar-area"
    >
      次月＞
    </button>
  </div>

  <script>
    // サーバーから渡された今日の日付（グローバルスコープで一度だけ宣言）
    if (typeof window.serverTodayDate === 'undefined') {
      window.serverTodayDate = '{{ today_date }}'
    }

    // 選択された日付をハイライトする関数
    if (typeof window.highlightSelectedDate === 'undefined') {
      window.highlightSelectedDate = function (date) {
        // まず全ての選択状態をクリア
        document.querySelectorAll('.selected-date').forEach((el) => el.classList.remove('selected-date'))
        document.querySelectorAll('.selected-column').forEach((el) => el.classList.remove('selected-column'))

        // セレクタをより具体的に指定して、確実に要素を取得
        const headerCell = document.querySelector(`th.calendar-cell[data-date="${date}"]`)
        if (headerCell) {
          headerCell.classList.add('selected-date')

          // 強制的にスタイルを再計算させる
          void headerCell.offsetHeight
        }

        // すべての該当セルを選択
        const dateCells = document.querySelectorAll(`td.calendar-cell[data-date="${date}"]`)
        dateCells.forEach((cell) => {
          cell.classList.add('selected-column')
          // 強制的にスタイルを再計算させる
          void cell.offsetHeight
        })

        // 選択した日付を保存
        localStorage.setItem('selectedDate', date)

        // 詳細情報を遅延読み込み
        window.loadDayDetail(date)
      }
    }

    // 日付の詳細情報を取得する関数
    if (typeof window.loadDayDetail === 'undefined') {
      window.loadDayDetail = function (date) {
        htmx.ajax('GET', `/day/${date}`, { target: '#detail-area' })
      }
    }

    // 今日の日付を取得する関数（キャッシュを使用）
    if (typeof window.cachedTodayDate === 'undefined') {
      // 初期値はnullではなく、サーバーから渡された今日の日付を使用
      window.cachedTodayDate = window.serverTodayDate || null
    }

    if (typeof window.getTodayDate === 'undefined') {
      window.getTodayDate = function () {
        // キャッシュがある場合はそれを返す
        if (window.cachedTodayDate) {
          return window.cachedTodayDate
        }

        // キャッシュがない場合は新しく生成
        if (window.serverTodayDate) {
          window.cachedTodayDate = window.serverTodayDate
        } else {
          const today = new Date()
          const year = today.getFullYear()
          const month = String(today.getMonth() + 1).padStart(2, '0')
          const day = String(today.getDate()).padStart(2, '0')
          window.cachedTodayDate = `${year}-${month}-${day}`
        }

        return window.cachedTodayDate
      }
    }

    // カレンダーの選択を効率的に設定する関数
    if (typeof window.setupCalendarSelection === 'undefined') {
      window.setupCalendarSelection = function () {
        const savedDate = localStorage.getItem('selectedDate')
        const todayDate = window.getTodayDate()

        // まず選択セルをすべて解除
        document.querySelectorAll('.selected-date, .selected-column').forEach((cell) => {
          cell.classList.remove('selected-date')
          cell.classList.remove('selected-column')
        })

        // 保存された日付または今日の日付のセルを検索
        let targetDate = null
        let targetCell = null

        if (savedDate) {
          targetCell = document.querySelector(`th.calendar-cell[data-date="${savedDate}"]`)
          if (targetCell) {
            targetDate = savedDate
          }
        }

        if (!targetCell) {
          targetCell = document.querySelector(`th.calendar-cell[data-date="${todayDate}"]`)
          if (targetCell) {
            targetDate = todayDate
          } else {
            // 最初のセルを代替として選択
            targetCell = document.querySelector('th.calendar-cell[data-date]')
            if (targetCell) {
              targetDate = targetCell.getAttribute('data-date')
            }
          }
        }

        if (targetDate) {
          window.highlightSelectedDate(targetDate)
          return true
        }

        return false
      }
    }

    // DOMが完全に読み込まれたタイミングで実行する関数
    if (typeof window.initCalendar === 'undefined') {
      window.initCalendar = function () {
        // すべてのDOM要素が読み込まれたことを確認
        const allCells = document.querySelectorAll('.calendar-cell')

        if (allCells.length > 0) {
          // セレクションの設定とday_detail表示
          const success = window.setupCalendarSelection()
          if (!success) {
            // 少し待ってリトライ
            setTimeout(window.setupCalendarSelection, 100)
          }
        } else {
          // セルが見つからない場合は再度試行
          setTimeout(window.initCalendar, 100)
        }
      }
    }

    // ページ読み込み完了時に実行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(window.initCalendar, 50)
      })
    } else {
      // すでにDOMが読み込まれている場合は直接実行
      setTimeout(window.initCalendar, 50)
    }

    // HTMX部分更新後の処理
    document.addEventListener('htmx:afterSwap', function (event) {
      if (event.detail.target.id === 'calendar-area') {
        // カレンダーの初期化を少し遅延して実行
        setTimeout(() => {
          window.initCalendar()
          // カレンダーロードイベントを発火
          document.dispatchEvent(new CustomEvent('sokora:calendarLoaded'))
        }, 50)
      }
    })

    // 日付の詳細表示用イベント
    document.addEventListener('sokora:calendarLoaded', function () {
      const selectedHeaderCell = document.querySelector('th.calendar-cell.selected-date')
      if (selectedHeaderCell) {
        const date = selectedHeaderCell.getAttribute('data-date')
        if (date) {
          window.loadDayDetail(date)
        }
      }
    })

    // Today強調表示用イベント
    document.addEventListener('sokora:highlightToday', function () {
      const todayDate = window.getTodayDate()
      window.highlightSelectedDate(todayDate)
    })
  </script>

  <style>
    /* カレンダーテーブルの固定レイアウト */
    table {
      table-layout: fixed !important;
    }

    /* 日付セルの幅を固定 */
    .calendar-cell {
      width: 20px !important;
      min-width: 20px !important;
      max-width: 20px !important;
      box-sizing: border-box;
    }

    /* 選択された日付ヘッダーのスタイル */
    .selected-date {
      border-top: 2px solid #888888 !important;
      border-left: 2px solid #888888 !important;
      border-right: 2px solid #888888 !important;
      background-color: rgba(136, 136, 136, 0.15) !important;
      position: relative;
      z-index: 5;
      font-weight: bold !important;
    }

    /* 選択された列のスタイル */
    .selected-column {
      border-left: 2px solid #888888 !important;
      border-right: 2px solid #888888 !important;
      background-color: rgba(136, 136, 136, 0.15) !important;
      position: relative;
      z-index: 5;
    }

    /* 最後の行のセルに下線を追加 */
    tr:last-child .selected-column {
      border-bottom: 2px solid #888888 !important;
    }

    /* 選択時にヘッダーセルを太字にする */
    th.selected-date {
      font-weight: bold !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* 祝日ツールチップのスタイル */
    .holiday-tooltip {
      cursor: help;
      text-decoration: underline dotted rgba(255, 107, 107, 0.5);
      position: relative;
    }

    .holiday-tooltip:hover {
      text-decoration: underline dotted rgba(255, 107, 107, 1);
    }

    /* カスタムツールチップ */
    .custom-tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip-text {
      visibility: hidden;
      width: auto;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 3px 8px;
      position: absolute;
      z-index: 100;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 0.7rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .custom-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* 三角形の矢印 */
    .tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }
  </style>
</section>
