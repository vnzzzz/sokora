{% macro modal(id, title, body, footer='', size='md', extra_cls='') -%}
<dialog id="{{ id }}" class="modal modal-{{ size }} {{ extra_cls }}">
  <div class="modal-box">
    <h3 class="font-bold text-lg">{{ title }}</h3>
    <div class="py-4">{{ body | safe }}</div>
    {%- if footer %}
    <div class="modal-action">{{ footer | safe }}</div>
    {%- endif %}
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{%- endmacro %}

{% macro form_errors(errors, field=None) -%}
{%- if errors %}
{%- if field %}
{%- set msgs = errors.get(field, []) %}
{%- for msg in msgs %}
<p class="text-error text-sm">{{ msg }}</p>
{%- endfor %}
{%- else %}
{%- for fld, msgs in errors.items() %}
{%- for msg in msgs %}
<p class="text-error text-sm">{{ fld }}: {{ msg }}</p>
{%- endfor %}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- endmacro %}

{% macro simple_error(error_message) -%}
{% if error_message %}
<div id="form-error" class="text-red-500 text-sm mt-2">{{ error_message }}</div>
{% endif %}
{%- endmacro %}

{% macro add_modal(title, form_id, content_block, endpoint_url, submit_btn_text="追加") -%}
<!-- 追加モーダル -->
<div
  x-show="showAddModal"
  @click.away="showAddModal = false"
  style="display: none"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
    <h3 class="font-bold text-lg mb-4 text-base-content">{{ title }}</h3>
    <form id="{{ form_id }}" class="space-y-4" hx-post="{{ endpoint_url }}" hx-indicator="#loading-indicator">
      <div id="add-form-error"></div>
      {{ content_block | safe }}
      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" class="btn btn-outline" @click="showAddModal = false">キャンセル</button>
        <button type="submit" class="btn btn-neutral shadow-sm">{{ submit_btn_text }}</button>
      </div>
    </form>
  </div>
</div>
{%- endmacro %}

{% macro edit_modal(title, form_id, content_block, item_id, btn_color_class="", submit_btn_text="保存")
-%}
<!-- 編集モーダル -->
<div
  x-show="showEditModal"
  @click.away="showEditModal = false"
  style="display: none"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
    <h3 class="font-bold text-lg mb-4 {{ btn_color_class }}">{{ title }}</h3>
    <div id="modal-content-edit-user-{{ item_id }}">{{ content_block | safe }}</div>
    <div id="edit-form-error-{{ item_id }}"></div>
  </div>
</div>
{%- endmacro %}

{% macro delete_confirm_modal(title, content_block, item_id, item_name, endpoint_url,
submit_btn_text="削除") -%}
<!-- 削除確認モーダル -->
<div
  x-show="showDeleteConfirm"
  @click.away="showDeleteConfirm = false"
  style="display: none"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
    <h3 class="font-bold text-lg mb-4 text-error text-left">{{ title }}</h3>
    <form id="delete-form-{{ item_id }}" class="space-y-4">
      <p class="mb-5 text-left">
        「{{ item_name }}」を削除してもよろしいですか？<br />
        この操作は元に戻せません。<br />
        {{ content_block | safe }}
      </p>
      <div class="flex justify-end space-x-3">
        <button type="button" class="btn btn-outline" @click="showDeleteConfirm = false">キャンセル</button>
        <button
          type="button"
          class="btn btn-error shadow-sm"
          hx-delete="{{ endpoint_url }}"
          hx-indicator="#loading-indicator"
        >
          {{ submit_btn_text }}
        </button>
      </div>
    </form>
  </div>
</div>
{%- endmacro %}

{% macro month_switcher(prev_month, next_month, current_month, url_base='/attendance',
target_id='calendar', use_htmx=true, user_id=None, class='') -%}
<!-- 月切り替えボタングループ -->
<div class="btn-group shadow-sm {{ class }}">
  <!-- 前月ボタン -->
  <button
    class="btn btn-sm btn-outline"
    {%
    if
    use_htmx
    %}
    {%
    if
    user_id
    %}
    hx-get="{{ url_base }}/{{ user_id }}?month={{ prev_month }}"
    {%
    else
    %}
    hx-get="{{ url_base }}?month={{ prev_month }}"
    {%
    endif
    %}
    hx-target="#{{ target_id }}"
    hx-swap="outerHTML"
    {%
    else
    %}
    onclick="navigateToMonth('{{ prev_month }}', '{{ user_id }}', '{{ url_base }}')"
    {%
    endif
    %}
  >
    ◀︎
  </button>

  <!-- 今月ボタン -->
  <button
    class="btn btn-sm btn-neutral"
    {%
    if
    use_htmx
    %}
    {%
    if
    user_id
    %}
    hx-get="{{ url_base }}/{{ user_id }}"
    {%
    else
    %}
    hx-get="{{ url_base }}"
    {%
    endif
    %}
    hx-target="#{{ target_id }}"
    hx-swap="outerHTML"
    {%
    else
    %}
    onclick="navigateToMonth('', '{{ user_id }}', '{{ url_base }}')"
    {%
    endif
    %}
  >
    今月
  </button>

  <!-- 翌月ボタン -->
  <button
    class="btn btn-sm btn-outline"
    {%
    if
    use_htmx
    %}
    {%
    if
    user_id
    %}
    hx-get="{{ url_base }}/{{ user_id }}?month={{ next_month }}"
    {%
    else
    %}
    hx-get="{{ url_base }}?month={{ next_month }}"
    {%
    endif
    %}
    hx-target="#{{ target_id }}"
    hx-swap="outerHTML"
    {%
    else
    %}
    onclick="navigateToMonth('{{ next_month }}', '{{ user_id }}', '{{ url_base }}')"
    {%
    endif
    %}
  >
    ▶︎
  </button>
</div>
{%- endmacro %}

{% macro loading_indicator(id='loading-indicator') -%}
{# HTMX Loading Indicator: https://htmx.org/indicators/ #}
<style>
  .htmx-indicator {
    display: none;
    opacity: 0;
    transition: opacity 200ms ease-in;
  }
  .htmx-request .htmx-indicator {
    display: inline;
    opacity: 1;
  }
  .htmx-request.htmx-indicator {
    display: inline;
    opacity: 1;
  }
</style>
<span id="{{ id }}" class="htmx-indicator ml-2">
  {# daisyUI spinner #}
  <span class="loading loading-spinner loading-sm"></span>
</span>
{%- endmacro %}

{% macro attendance_modal(user_id, date, user_name, formatted_date, attendance_id, current_location_id, locations) -%}
<dialog id="attendance-modal-{{ user_id }}-{{ date }}" class="modal modal-open bg-black/30">
  <form method="dialog" class="modal-box" id="attendance-form-{{ user_id }}-{{ date }}">
    <h3 class="font-bold text-lg">勤怠編集: {{ user_name }} ({{ formatted_date }})</h3>

    <input type="hidden" name="user_id" value="{{ user_id }}">
    <input type="hidden" name="date" value="{{ date }}">
    {% if attendance_id %}
    <input type="hidden" name="_method" value="PUT"> {# 更新の場合 #}
    {% endif %}

    <div class="py-4">
      <label class="label" for="location-{{ user_id }}-{{ date }}">
        <span class="label-text">勤務場所</span>
      </label>
      <select id="location-{{ user_id }}-{{ date }}" name="location_id" class="select select-bordered w-full">
        {% for location in locations %}
        <option value="{{ location.id }}" {% if location.id == current_location_id %}selected{% endif %}>
          {{ location.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="modal-action">
      {# HTMXによる閉じるボタン #}
      <button type="button" class="btn btn-ghost" onclick="document.getElementById('attendance-modal-{{ user_id }}-{{ date }}').remove()">閉じる</button> {# .close() から .remove() に変更し、要素ごと削除 #}

      {# 削除ボタン (勤怠データが存在する場合のみ表示) #}
      {% if attendance_id %}
      <button
        type="button"
        class="btn btn-error"
        hx-delete="/api/attendances/?user_id={{ user_id }}&date={{ date }}"
        hx-indicator="#modal-loading-{{ user_id }}-{{ date }}"
      >
        削除
      </button>
      {% endif %}

      {# 登録/更新ボタン #}
      <button
        type="submit"
        class="btn btn-neutral"
        {% if attendance_id %}
          hx-put="/api/attendances/{{ attendance_id }}" {# 更新 #}
          hx-ext="json-enc" {# PUTの時だけJSON送信 #}
        {% else %}
          hx-post="/api/attendances/"                 {# 登録 #}
        {% endif %}
        hx-indicator="#modal-loading-{{ user_id }}-{{ date }}"
        {# フォームデータをインクルード #}
        hx-include="#attendance-form-{{ user_id }}-{{ date }}"
      >
        {% if attendance_id %}更新{% else %}登録{% endif %}
      </button>
      {# ローディングインジケータ #}
      <span class="loading loading-spinner loading-sm hidden" id="modal-loading-{{ user_id }}-{{ date }}"></span>
    </div>
  </form>
</dialog>
{%- endmacro %}

{# モーダル＋フォーム送信の汎用マクロ #}
{% macro modal_form(id, title, action, method="POST",
                    submit_text="保存", size="md", extra_cls="") -%}
<dialog id="{{ id }}" class="modal modal-{{ size }} {{ extra_cls }}">
  <div class="modal-box">
    <h3 class="font-bold text-lg">{{ title }}</h3>
    <div class="py-4">
      <form id="{{ id }}-form"
            hx-{{ method|lower }}="{{ action }}"
            hx-target="closest dialog"
            hx-swap="outerHTML"
            class="space-y-4">
        {{ caller() }}
      </form>
    </div>
    <div class="modal-action">
      <button form="{{ id }}-form" class="btn btn-neutral">{{ submit_text }}</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{%- endmacro %}

{# 削除確認モーダルの汎用マクロ #}
{% macro delete_modal_form(id, title, action, item_name, 
                          submit_text="削除", size="sm", extra_cls="") -%}
<dialog id="{{ id }}" class="modal modal-{{ size }} {{ extra_cls }}">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">{{ title }}</h3>
    <div class="py-4">
      <p class="mb-5 text-left">
        「{{ item_name }}」を削除してもよろしいですか？<br />
        この操作は元に戻せません。<br />
        {{ caller() }}
      </p>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-outline mr-2">キャンセル</button>
      </form>
      <button class="btn btn-error"
              hx-delete="{{ action }}"
              hx-target="closest dialog"
              hx-swap="outerHTML">
        {{ submit_text }}
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{%- endmacro %}
