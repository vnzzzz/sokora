{% extends "layout/base.html" %} {% set title_text = "勤怠登録" %} {% block content %}
<div class="p-4">
  <div class="flex justify-between items-center mb-3">
    <div>
      <h2 class="text-lg font-bold text-base-content">勤怠登録</h2>
    </div>
    <form id="month-nav-form" class="hidden">
      <input type="hidden" name="month" id="month-value" value="" />
    </form>
  </div>

  <div class="mt-4">
    {% if users|length == 0 %}
    <div class="alert alert-info shadow-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <span>社員情報がありません。社員管理ページから社員を追加してください。</span>
    </div>
    {% else %}

    <!-- コンテンツ全体をHTMXターゲットとするコンテナ -->
    <div
      id="attendance-content"
      hx-get="/attendance"
      hx-trigger="refreshAttendance from:body"
      hx-target="#attendance-content"
      hx-swap="innerHTML"
    >
      {# 部分テンプレートを読み込む #} {% include "pages/attendance/attendance_calendar.html" %}
    </div>

    <!-- 勤怠入力用モーダル (Alpine.js) -->
    <div
      x-data="{
        showAttendanceModal: false, 
        userId: '', 
        userName: '', 
        date: '', 
        formattedDate: '', 
        selectedLocationId: null, 
        hasData: false,

        deleteAttendance() {
          if (!this.userId || !this.date) {
            alert('削除に必要な情報が不足しています。')
            return
          }
          fetch(`/api/attendances/?user_id=${encodeURIComponent(this.userId)}&date=${encodeURIComponent(this.date)}`, {
            method: 'DELETE'
          })
          .then((response) => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || 'サーバーエラー'); });
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              // モーダルを閉じるイベントを発行 (this ではなく window)
              window.dispatchEvent(new CustomEvent('close-attendance-modal'))
              window.location.reload() // Or trigger HTMX refresh
            } else {
              alert('エラー: ' + (data.message || '勤怠の削除に失敗しました'))
            }
          })
          .catch((error) => {
            console.error('勤怠削除エラー:', error)
            alert('勤怠の削除処理中にエラーが発生しました: ' + error.message)
          })
        }
      }"
      x-on:open-attendance-modal.window="
           showAttendanceModal = true; 
           userId = $event.detail.userId; 
           userName = $event.detail.userName; 
           date = $event.detail.date;
           formattedDate = $event.detail.formattedDate;
           selectedLocationId = $event.detail.locationId || null;
           hasData = $event.detail.hasData;"
      x-on:close-attendance-modal.window="showAttendanceModal = false"
      class="attendance-modal-container"
    >
      <div
        x-show="showAttendanceModal"
        style="display: none"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
        @click.away="showAttendanceModal = false"
      >
        <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-sm w-full" @click.stop>
          <h3 class="font-bold text-lg mb-4 text-base-content">
            <span x-text="userName"></span>：
            <span class="text-sm font-normal"><span x-text="date"></span></span>
          </h3>

          <form id="attendance-form" class="space-y-4">
            <input type="hidden" name="user_id" x-model="userId" />
            <input type="hidden" name="date" x-model="date" />

            <div class="form-control">
              <div class="label">
                <span class="label-text">勤務場所</span>
              </div>
              <div class="space-y-2">
                {% for location_type in location_types %} {% set location_id = loop.index %} {% set input_id =
                "location_" ~ location_id %} {% set style_class = location_styles[location_type]|default('') %}
                <label
                  for="{{ input_id }}"
                  class="flex items-center p-2 cursor-pointer {{ style_class }}"
                  :class="{ 'ring-2 ring-primary': selectedLocationId === {{ location_id }} }"
                >
                  <input
                    type="radio"
                    name="location_id"
                    value="{{ location_id }}"
                    id="{{ input_id }}"
                    class="radio radio-sm mr-2"
                    x-model="selectedLocationId"
                    x-on:change="selectedLocationId = {{ location_id }}"
                  />
                  <span>{{ location_type }}</span>
                </label>
                {% endfor %}
              </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
              <button type="button" class="btn btn-outline" @click="showAttendanceModal = false">キャンセル</button>
              <button
                type="button"
                class="btn btn-error btn-outline shadow-sm"
                x-show="hasData"
                @click="window.attendanceHandlers.deleteAttendance(userId, date)"
              >
                削除
              </button>
              <button
                type="button"
                class="btn btn-neutral shadow-sm"
                x-bind:disabled="selectedLocationId === null"
                @click="window.attendanceHandlers.submitAttendance()"
              >
                登録
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% endif %}
  </div>
</div>

<!-- 勤怠マトリックス用スタイル -->
<style>
  .attendance-cell:hover {
    opacity: 0.8;
    transition: all 0.2s;
  }
</style>
{% endblock %}
