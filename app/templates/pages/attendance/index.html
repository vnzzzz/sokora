{% extends "layout/base.html" %} {% set title_text = "勤怠登録 - Sokora" %} {% block content %}
<div class="card bg-base-200 shadow-lg rounded-lg">
  <div class="card-body p-6">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold text-base-content">勤怠登録</h2>
      </div>
      <form id="month-nav-form" class="hidden">
        <input type="hidden" name="month" id="month-value" value="" />
      </form>
    </div>

    <div class="mt-8">
      {% if users|length == 0 %}
      <div class="alert alert-info shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <span>社員情報がありません。社員管理ページから社員を追加してください。</span>
      </div>
      {% else %}

      <!-- 検索フォーム -->
      <div class="mb-6">
        <div class="form-control">
          <div class="input-group">
            <input
              type="text"
              placeholder="社員名またはIDを検索..."
              class="input input-bordered w-full"
              hx-get="/attendance"
              hx-trigger="keyup changed delay:300ms"
              hx-target="#attendance-content"
              hx-include="[name='search_query']"
              name="search_query"
              hx-swap="innerHTML"
            />
            <button class="btn btn-square">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- コンテンツ全体をHTMXターゲットとするコンテナ -->
      <div id="attendance-content">
        {# 部分テンプレートを読み込む #} {% include "pages/attendance/attendance_content.html" %}
      </div>

      <!-- 勤怠入力用モーダル (Alpine.js) -->
      <div
        x-data="{
          showAttendanceModal: false, 
          userId: '', 
          userName: '', 
          date: '', 
          formattedDate: '', 
          selectedLocationId: null, 
          hasData: false,

          deleteAttendance() {
            if (!this.userId || !this.date) {
              alert('削除に必要な情報が不足しています。')
              return
            }
            fetch(`/api/attendances/?user_id=${encodeURIComponent(this.userId)}&date=${encodeURIComponent(this.date)}`, {
              method: 'DELETE'
            })
            .then((response) => {
              if (!response.ok) {
                  return response.json().then(err => { throw new Error(err.detail || 'サーバーエラー'); });
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                // モーダルを閉じるイベントを発行 (this ではなく window)
                window.dispatchEvent(new CustomEvent('close-attendance-modal'))
                window.location.reload() // Or trigger HTMX refresh
              } else {
                alert('エラー: ' + (data.message || '勤怠の削除に失敗しました'))
              }
            })
            .catch((error) => {
              console.error('勤怠削除エラー:', error)
              alert('勤怠の削除処理中にエラーが発生しました: ' + error.message)
            })
          }
        }"
        x-on:open-attendance-modal.window="
             showAttendanceModal = true; 
             userId = $event.detail.userId; 
             userName = $event.detail.userName; 
             date = $event.detail.date;
             formattedDate = formatDateJa(date);
             selectedLocationId = $event.detail.locationId || null;
             hasData = $event.detail.hasData;"
        x-on:close-attendance-modal.window="showAttendanceModal = false"
        class="attendance-modal-container"
      >
        <div
          x-show="showAttendanceModal"
          style="display: none"
          class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
          @click.away="showAttendanceModal = false"
        >
          <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
            <h3 class="font-bold text-lg mb-4 text-base-content">
              勤怠登録：<span x-text="userName"></span>
              <span class="text-sm font-normal">(<span x-text="formattedDate"></span>)</span>
            </h3>

            <form id="attendance-form" class="space-y-4">
              <input type="hidden" name="user_id" x-model="userId" />
              <input type="hidden" name="date" x-model="date" />

              <div class="form-control">
                <div class="label">
                  <span class="label-text">勤務場所</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  {% for location_type in location_types %} {% set location_id = loop.index %} {% set input_id =
                  "location_" ~ location_id %} {% set style_class = location_styles[location_type]|default('') %}
                  <label
                    for="{{ input_id }}"
                    class="flex items-center p-2 border rounded cursor-pointer {{ style_class }}"
                    :class="{ 'ring-2 ring-primary': selectedLocationId === {{ location_id }} }"
                  >
                    <input
                      type="radio"
                      name="location_id"
                      value="{{ location_id }}"
                      id="{{ input_id }}"
                      class="radio radio-sm mr-2"
                      x-model="selectedLocationId"
                      x-on:change="selectedLocationId = {{ location_id }}"
                    />
                    <span>{{ location_type }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>

              <div class="flex justify-end space-x-3 mt-6">
                <button type="button" class="btn btn-outline" @click="showAttendanceModal = false">キャンセル</button>
                <button
                  type="button"
                  class="btn btn-error btn-outline shadow-sm"
                  x-show="hasData"
                  @click="deleteAttendance()"
                >
                  削除
                </button>
                <button
                  type="button"
                  class="btn btn-neutral shadow-sm"
                  x-bind:disabled="selectedLocationId === null"
                  @click="submitAttendance()"
                >
                  登録
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% endif %}
    </div>
  </div>
</div>

<!-- 勤怠マトリックス用スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 勤怠セルのクリックイベント設定
    // HTMXで部分更新される可能性があるため、イベント委譲を利用
    document.body.addEventListener('click', function (event) {
      if (event.target.closest('.attendance-cell')) {
        const cell = event.target.closest('.attendance-cell')
        const userId = cell.dataset.userId
        const userName = cell.dataset.userName
        const date = cell.dataset.date
        const hasData = cell.dataset.hasData === 'true'
        const locationName = cell.dataset.location || ''

        // 既存の勤務場所に基づいて初期ロケーションIDを設定
        let locationId = null
        if (hasData) {
          const locationTypes = JSON.parse('{{ location_types|tojson|safe }}')
          const locationIndex = locationTypes.indexOf(locationName)
          locationId = locationIndex >= 0 ? locationIndex + 1 : null
        }

        // カスタムイベントでモーダルを開く
        window.dispatchEvent(
          new CustomEvent('open-attendance-modal', {
            detail: {
              userId,
              userName,
              date,
              locationId,
              hasData: hasData
            }
          })
        )
      }
    })

    // 勤怠登録送信処理
    window.submitAttendance = function () {
      const form = document.getElementById('attendance-form')
      const formData = new FormData(form)

      fetch('/api/attendances/', {
        method: 'POST',
        body: formData
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((err) => {
              throw new Error(err.detail || 'サーバーエラー')
            })
          }
          return response.json()
        })
        .then((data) => {
          if (data.success) {
            // モーダルを閉じるイベントを発行
            window.dispatchEvent(new CustomEvent('close-attendance-modal'))

            // 画面を更新 (HTMXリクエストで更新する方が望ましいが、一旦リロード)
            // TODO: HTMXでの部分更新に切り替える
            // 例: htmx.trigger('#attendance-content', 'load');
            window.location.reload()
          } else {
            alert('エラー: ' + (data.message || '勤怠の登録に失敗しました'))
          }
        })
        .catch((error) => {
          console.error('勤怠登録エラー:', error)
          alert('勤怠の登録処理中にエラーが発生しました: ' + error.message)
        })
    }

    // 日本語の日付フォーマット関数
    window.formatDateJa = function (dateStr) {
      const date = new Date(dateStr)
      const year = date.getFullYear()
      const month = date.getMonth() + 1
      const day = date.getDate()
      const weekdays = ['日', '月', '火', '水', '木', '金', '土']
      const weekday = weekdays[date.getDay()]

      return `${year}年${month}月${day}日(${weekday})`
    }
  })
</script>

<!-- 勤怠マトリックス用スタイル -->
<style>
  .attendance-cell:hover {
    opacity: 0.8;
    transition: all 0.2s;
  }
</style>
{% endblock %}
