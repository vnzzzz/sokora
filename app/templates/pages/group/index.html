{% extends "layout/base.html" %} {% set title_text = "グループ管理 - Sokora" %} {% block content %}
<div class="card bg-base-200 shadow-lg rounded-lg">
  <div class="card-body p-6">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold text-base-content">グループ管理</h2>
      </div>

      <!-- 新規追加ボタン -->
      <div x-data="{ showAddModal: false }" @click.away="showAddModal = false">
        <button @click="showAddModal = true" class="btn btn-sm btn-outline shadow-sm hover:shadow">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-4 h-4 mr-1"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
            />
          </svg>
          グループ追加
        </button>

        <!-- 新規追加モーダル -->
        <div
          x-show="showAddModal"
          style="display: none"
          class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
        >
          <div
            class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full"
            @click.away="showAddModal = false"
            @click.stop
          >
            <h3 class="font-bold text-lg mb-4 text-base-content">グループ追加</h3>
            <form id="new-group-form" class="space-y-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">グループ名</span>
                </label>
                <input type="text" name="name" class="input input-bordered w-full focus:border-neutral" required />
              </div>
              <div class="flex justify-end space-x-3 mt-6">
                <button type="button" class="btn btn-outline" @click="showAddModal = false">キャンセル</button>
                <button type="button" class="btn btn-neutral shadow-sm" id="add-group-button">追加</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- グループ一覧 -->
    <div class="mt-8">
      {% if not groups %}
      <div class="alert alert-info shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <span>グループが登録されていません。新しいグループを追加してください。</span>
      </div>
      {% else %}
      <div class="overflow-x-auto rounded-lg">
        <table class="table table-zebra w-full">
          <thead class="bg-base-300 text-base-content">
            <tr>
              <th class="rounded-tl-lg">グループ名</th>
              <th class="text-right rounded-tr-lg">操作</th>
            </tr>
          </thead>
          <tbody>
            {% for group in groups %}
            <tr class="hover:bg-base-200" id="group-row-{{ group.group_id }}">
              <td class="font-medium">{{ group.name }}</td>
              <td class="text-right">
                <div class="flex justify-end gap-2">
                  <div x-data="{ showEditModal: false }">
                    <button @click="showEditModal = true" class="btn btn-sm btn-outline shadow-sm hover:shadow">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4 mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"
                        />
                      </svg>
                      編集
                    </button>

                    <!-- 編集モーダル -->
                    <div
                      x-show="showEditModal"
                      @click.away="showEditModal = false"
                      style="display: none"
                      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
                    >
                      <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
                        <h3 class="font-bold text-lg mb-4 text-base-content">グループ編集</h3>
                        <form id="edit-form-{{ group.group_id }}" class="space-y-4">
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text">グループ名</span>
                            </label>
                            <input
                              type="text"
                              name="name"
                              value="{{ group.name }}"
                              class="input input-bordered focus:border-neutral"
                              required
                            />
                          </div>
                          <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" class="btn btn-outline" @click="showEditModal = false">
                              キャンセル
                            </button>
                            <button
                              type="button"
                              class="btn btn-neutral shadow-sm edit-group-button"
                              data-group-id="{{ group.group_id }}"
                            >
                              保存
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div x-data="{ showDeleteConfirm: false }">
                    <button
                      @click="showDeleteConfirm = true"
                      class="btn btn-sm btn-error btn-outline shadow-sm hover:shadow"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4 mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
                        />
                      </svg>
                      削除
                    </button>

                    <!-- 削除確認モーダル -->
                    <div
                      x-show="showDeleteConfirm"
                      @click.away="showDeleteConfirm = false"
                      style="display: none"
                      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
                    >
                      <div class="bg-base-100 p-6 rounded-xl shadow-2xl max-w-md w-full" @click.stop>
                        <h3 class="font-bold text-lg mb-4 text-error">削除の確認</h3>
                        <p class="mb-5">「{{ group.name }}」を削除してもよろしいですか？この操作は元に戻せません。</p>
                        <div class="flex justify-end space-x-3">
                          <button type="button" class="btn btn-outline" @click="showDeleteConfirm = false">
                            キャンセル
                          </button>
                          <button
                            type="button"
                            class="btn btn-error shadow-sm delete-group-button"
                            data-group-id="{{ group.group_id }}"
                          >
                            削除
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 新規追加処理
    document.getElementById('add-group-button').addEventListener('click', function () {
      const form = document.getElementById('new-group-form')
      const name = form.querySelector('input[name="name"]').value.trim()

      if (!name) {
        alert('グループ名を入力してください')
        return
      }

      // APIにPOSTリクエスト
      fetch('/api/groups/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name })
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            alert('エラーが発生しました: ' + data.error)
          } else {
            window.location.reload()
          }
        })
        .catch((error) => {
          alert('エラーが発生しました: ' + error)
        })
    })

    // 編集処理
    document.querySelectorAll('.edit-group-button').forEach((button) => {
      button.addEventListener('click', function () {
        const groupId = this.getAttribute('data-group-id')
        const form = document.getElementById('edit-form-' + groupId)
        const name = form.querySelector('input[name="name"]').value.trim()

        if (!name) {
          alert('グループ名を入力してください')
          return
        }

        // APIにPUTリクエスト
        fetch('/api/groups/' + groupId, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert('エラーが発生しました: ' + data.error)
            } else {
              window.location.reload()
            }
          })
          .catch((error) => {
            alert('エラーが発生しました: ' + error)
          })
      })
    })

    // 削除処理
    document.querySelectorAll('.delete-group-button').forEach((button) => {
      button.addEventListener('click', function () {
        const groupId = this.getAttribute('data-group-id')

        // APIにDELETEリクエスト
        fetch('/api/groups/' + groupId, {
          method: 'DELETE'
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert('エラーが発生しました: ' + data.error)
            } else {
              // 削除成功したら該当行を削除
              const row = document.getElementById('group-row-' + groupId)
              if (row) {
                row.remove()
              }

              // 行がなくなったら「データなし」表示を出す
              const tbody = document.querySelector('tbody')
              if (tbody && tbody.children.length === 0) {
                window.location.reload()
              }
            }
          })
          .catch((error) => {
            alert('エラーが発生しました: ' + error)
          })
      })
    })
  })
</script>
{% endblock %}
