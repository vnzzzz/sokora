<!DOCTYPE html>
<html lang="ja" x-data class="bg-base-100">

{% set title_text = user_name + " (" + user_id + ") - 登録 - Sokora" %}
{% include "components/head.html" %}

<body class="min-h-screen bg-base-100">
  <!-- テーマ切替ボタン -->
  {% include "components/theme_switcher.html" %}

  <!-- ヘッダー -->
  {% include "components/navbar.html" %}

  <!-- メインコンテンツ -->
  <main class="container mx-auto p-4 space-y-6">
    <div class="card bg-base-200 shadow-sm">
      <div class="card-body">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold mb-1">{{ user_name }} ({{ user_id }}) - 登録</h2>
            <div class="text-sm breadcrumbs">
              <ul>
                <li><a href="/attendance">勤怠</a></li>
                <li>{{ user_name }} ({{ user_id }})</li>
              </ul>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline" hx-get="/attendance/edit/{{ user_id }}?month={{ prev_month }}"
              hx-target="body">＜前月</button>
            <button class="btn btn-sm" hx-get="/attendance/edit/{{ user_id }}" hx-target="body">今月</button>
            <button class="btn btn-sm btn-outline" hx-get="/attendance/edit/{{ user_id }}?month={{ next_month }}"
              hx-target="body">次月＞</button>
          </div>
        </div>

        <!-- 勤怠カレンダー -->
        <div class="overflow-x-auto mt-4">
          <h3 class="text-xl font-bold text-center mb-4">{{ month_name }}</h3>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th class="text-center">日</th>
                <th class="text-center">月</th>
                <th class="text-center">火</th>
                <th class="text-center">水</th>
                <th class="text-center">木</th>
                <th class="text-center">金</th>
                <th class="text-center">土</th>
              </tr>
            </thead>
            <tbody>
              {% for week in calendar_data %}
              <tr>
                {% for day in week %}
                {% if day %}
                <td class="p-0">
                  <div
                    class="calendar-day p-2 min-h-16 flex flex-col h-full {% if day.date in user_dates %}has-data{% endif %}">
                    <div class="flex justify-between items-start mb-1">
                      <span class="font-semibold">{{ day.day }}</span>
                    </div>

                    <div class="flex-grow flex items-center justify-center">
                      {% if day.date in user_locations %}
                      <div class="flex items-center justify-between w-full">
                        <div
                          class="flex-grow text-center py-2 font-medium text-base bg-opacity-20 rounded-md {{ location_styles[user_locations[day.date]] }}">
                          {{ user_locations[day.date] }}
                        </div>
                        <div x-data="{ open: false }" class="ml-1">
                          <button @click="open = true"
                            class="btn btn-xs btn-ghost btn-circle opacity-50 hover:opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                              stroke="currentColor" class="w-3 h-3">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                            </svg>
                          </button>

                          <!-- 編集モーダル -->
                          <div x-show="open" style="display:none;"
                            class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                            <div class="bg-base-100 p-6 rounded-lg shadow-xl max-w-md w-full" @click.away="open = false"
                              @click.stop>
                              <h3 class="font-bold text-lg mb-2">{{ day.date }}の勤務場所を編集</h3>
                              <p class="text-sm mb-4">{{ user_name }} ({{ user_id }})の勤務場所を選択してください</p>

                              <form action="/api/attendance/update" method="post" class="space-y-4">
                                <input type="hidden" name="user_id" value="{{ user_id }}">
                                <input type="hidden" name="date" value="{{ day.date }}">

                                <div class="form-control">
                                  <div class="relative">
                                    <input type="text" name="location" list="location-options-{{ day.date }}"
                                      class="input input-bordered w-full location-input" placeholder="勤務場所を選択または入力"
                                      value="{% if day.date in user_locations %}{{ user_locations[day.date] }}{% endif %}"
                                      aria-label="勤務場所" aria-required="true" required autocomplete="off">
                                    <datalist id="location-options-{{ day.date }}">
                                      <option value="">未設定</option>
                                      {% for location_type in location_types %}
                                      <option value="{{ location_type }}">{{ location_type }}</option>
                                      {% endfor %}
                                    </datalist>
                                  </div>
                                  <p class="text-xs text-base-content/70 mt-1">既存の勤務場所から選択するか、新しい勤務場所を入力してください</p>
                                  <div class="error-message text-error text-sm mt-1" style="display: none;">
                                    勤務場所を入力してください</div>
                                </div>

                                <div class="flex justify-end space-x-2">
                                  <button type="button" class="btn btn-outline btn-sm"
                                    @click="open = false">キャンセル</button>
                                  <button type="submit" class="btn btn-primary btn-sm">保存</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% else %}
                      <div class="flex items-center justify-end w-full">
                        <div x-data="{ open: false }">
                          <button @click="open = true"
                            class="btn btn-xs btn-ghost btn-circle opacity-50 hover:opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                              stroke="currentColor" class="w-3 h-3">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                            </svg>
                          </button>

                          <!-- 編集モーダル -->
                          <div x-show="open" style="display:none;"
                            class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                            <div class="bg-base-100 p-6 rounded-lg shadow-xl max-w-md w-full" @click.away="open = false"
                              @click.stop>
                              <h3 class="font-bold text-lg mb-2">{{ day.date }}の勤務場所を編集</h3>
                              <p class="text-sm mb-4">{{ user_name }} ({{ user_id }})の勤務場所を選択してください</p>

                              <form action="/api/attendance/update" method="post" class="space-y-4">
                                <input type="hidden" name="user_id" value="{{ user_id }}">
                                <input type="hidden" name="date" value="{{ day.date }}">

                                <div class="form-control">
                                  <div class="relative">
                                    <input type="text" name="location" list="location-options-new-{{ day.date }}"
                                      class="input input-bordered w-full location-input" placeholder="勤務場所を選択または入力"
                                      value="" aria-label="勤務場所" aria-required="true" required autocomplete="off">
                                    <datalist id="location-options-new-{{ day.date }}">
                                      <option value="">未設定</option>
                                      {% for location_type in location_types %}
                                      <option value="{{ location_type }}">{{ location_type }}</option>
                                      {% endfor %}
                                    </datalist>
                                  </div>
                                  <p class="text-xs text-base-content/70 mt-1">既存の勤務場所から選択するか、新しい勤務場所を入力してください</p>
                                  <div class="error-message text-error text-sm mt-1" style="display: none;">
                                    勤務場所を入力してください</div>
                                </div>

                                <div class="flex justify-end space-x-2">
                                  <button type="button" class="btn btn-outline btn-sm"
                                    @click="open = false">キャンセル</button>
                                  <button type="submit" class="btn btn-primary btn-sm">保存</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </td>
                {% else %}
                <td></td>
                {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="flex justify-between items-center mt-4">
          <a href="/attendance" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-5 h-5 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
            </svg>
            戻る
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- カレンダースタイル -->
  <style>
    .calendar-day {
      transition: all 0.2s ease;
      min-height: 5rem;
    }

    .calendar-day:hover {
      background-color: rgba(var(--color-primary) / 0.1);
    }

    .has-data {
      background-color: rgba(var(--color-primary) / 0.05);
    }

    /* 勤務場所入力スタイル */
    .location-input:focus {
      border-color: hsl(var(--p));
      box-shadow: 0 0 0 1px hsla(var(--p) / 30%);
    }

    .location-input.error {
      border-color: hsl(var(--er));
    }
  </style>

  <!-- JavaScript -->
  <script>
    // 勤務場所入力の検証
    document.addEventListener('DOMContentLoaded', function () {
      // すべての勤務場所フォームを取得
      const forms = document.querySelectorAll('form[action="/api/attendance/update"]');

      forms.forEach(form => {
        const locationInput = form.querySelector('input[name="location"]');
        const errorMessage = form.querySelector('.error-message');

        // エラーメッセージを表示する関数
        const showError = () => {
          if (errorMessage) {
            errorMessage.style.display = 'block';
            locationInput.classList.add('error');
          }
        };

        // エラーメッセージを非表示にする関数
        const hideError = () => {
          if (errorMessage) {
            errorMessage.style.display = 'none';
            locationInput.classList.remove('error');
          }
        };

        form.addEventListener('submit', function (e) {
          // 入力値の前後の空白を削除
          locationInput.value = locationInput.value.trim();

          // 空の値をチェック
          if (locationInput.value === '') {
            e.preventDefault();
            showError();
            locationInput.focus();
          } else {
            hideError();
          }
        });

        if (locationInput) {
          // 入力時にエラーを非表示
          locationInput.addEventListener('input', function () {
            if (this.value.trim() !== '') {
              hideError();
            }
          });

          // フォーカスが外れたときに空白を削除
          locationInput.addEventListener('blur', function () {
            this.value = this.value.trim();
            if (this.value === '') {
              showError();
            } else {
              hideError();
            }
          });

          // ドロップダウンを既存の値でより良く動作させるためのクリックイベント
          locationInput.addEventListener('click', function () {
            // 置き換えを容易にするためにすべてのテキストを選択
            this.select();

            // ドロップダウンを強制的に表示するために値を削除して設定
            const currentValue = this.value;
            if (currentValue) {
              // ドロップダウンをトリガーするために一時的に消去して復元
              this.value = '';
              // ブラウザが処理する時間を確保するためにsetTimeoutを使用
              setTimeout(() => {
                this.value = currentValue;
                this.select(); // テキストを再度選択
              }, 10);
            }
          });

          // フォーカスイベントも処理
          locationInput.addEventListener('focus', function () {
            this.select();
          });
        }
      });
    });

    // モーダルを正しく初期化
    document.addEventListener('DOMContentLoaded', function () {
      // カレンダーセル内のすべての編集ボタン
      document.querySelectorAll('[x-data="{ open: false }"]').forEach(modalContainer => {
        const editButton = modalContainer.querySelector('button');
        const modalDialog = modalContainer.querySelector('.fixed.inset-0');
        const locationInput = modalContainer.querySelector('input[name="location"]');

        if (editButton && modalDialog && locationInput) {
          // モーダルが開いたときに入力にフォーカスを設定
          editButton.addEventListener('click', function () {
            // Alpine.jsがモーダルを表示するのを待つためにsetTimeoutを使用
            setTimeout(() => {
              locationInput.focus();
              locationInput.select();
            }, 50);
          });
        }
      });
    });
  </script>
</body>

</html>