<!DOCTYPE html>
<html lang="ja" x-data>

<head>
  <meta charset="utf-8">
  <title>sokora</title>
  <!-- ミニファイドJSはDockerfileで取得して/static/jsに配置 -->
  <script src="/static/js/alpine.min.js" defer></script>
  <script src="/static/js/htmx.min.js"></script>
  <script src="/static/js/chart.min.js"></script>
  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>

  <header>
    <h1>Sokora</h1>
    <button hx-get="/api/csv/export" hx-target="#detail-area">Download CSV</button>
    <button @click="showImport = true">Upload CSV</button>
    <div x-data="{ showImport: false }" x-show="showImport" style="display:none;">
      <form hx-post="/api/csv/import" hx-encoding="multipart/form-data" hx-target="#detail-area">
        <input type="file" name="file">
        <button type="submit">Import</button>
        <button type="button" @click="showImport = false">Cancel</button>
      </form>
    </div>
  </header>

  <main style="display: flex; flex-direction: column; gap: 20px;">
    <!-- カレンダー領域 -->
    <div id="calendar-area" hx-get="/api/calendar" hx-trigger="load" hx-target="#calendar-area">
      <!-- 初期ロード時に /api/calendar を呼び出し、ここに差し込み -->
    </div>

    <!-- 日別・ユーザー別の詳細表示領域 -->
    <div id="detail-area">
      <!-- デフォルトで今日のデータを表示 -->
      {% if default_day and default_data %}
      <section>
        <h3>{{ default_day }} の詳細</h3>

        {% if default_data["在宅"]|length == 0 and default_data["出社"]|length == 0 and default_data["出張"]|length == 0 %}
        <div class="no-data-message">
          この日のデータはありません
        </div>
        {% else %}
        <!-- 勤務場所データと円グラフ、社員リスト -->
        <div class="day-detail-container">
          <!-- 左側：グラフエリア -->
          <div class="day-chart-area">
            <div class="location-chart-container">
              <canvas id="location-pie-chart"></canvas>
            </div>
          </div>

          <!-- 右側：社員リストエリア -->
          <div class="day-user-list-area">
            <div class="user-lists">
              <div class="user-category">
                <h4>在宅</h4>
                <ul>
                  {% for user in default_data["在宅"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
                <div class="user-count">合計: {{ default_data["在宅"]|length }}名</div>
              </div>

              <div class="user-category">
                <h4>出社</h4>
                <ul>
                  {% for user in default_data["出社"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
                <div class="user-count">合計: {{ default_data["出社"]|length }}名</div>
              </div>

              <div class="user-category">
                <h4>出張</h4>
                <ul>
                  {% for user in default_data["出張"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
                <div class="user-count">合計: {{ default_data["出張"]|length }}名</div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </section>
      {% endif %}
    </div>
  </main>

  <script>
    document.addEventListener('htmx:afterSwap', function (event) {
      // カレンダーエリアが更新されたときにチャートを再初期化
      if (event.detail.target.id === 'calendar-area') {
        const charts = document.querySelectorAll('.day-chart');
        charts.forEach(canvas => {
          if (canvas.id) {
            // 既存のチャートがあれば破棄する
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
              existingChart.destroy();
            }

            const dayData = canvas.id.replace('chart-', '').split('-');
            const day = parseInt(dayData[2]);

            const parentCell = canvas.closest('td');
            const homeCount = parseInt(parentCell.querySelector('.day-stats').innerText.match(/在宅: (\d+)/)[1]);
            const officeCount = parseInt(parentCell.querySelector('.day-stats').innerText.match(/出社: (\d+)/)[1]);
            const tripCount = parseInt(parentCell.querySelector('.day-stats').innerText.match(/出張: (\d+)/)[1]);

            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: ['在宅', '出社', '出張'],
                datasets: [{
                  data: [homeCount, officeCount, tripCount],
                  backgroundColor: [
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)'
                  ]
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    enabled: true
                  }
                }
              }
            });
          }
        });
      }
    });

    // 初期表示時に今日のデータのパイチャートを描画
    document.addEventListener('DOMContentLoaded', function () {
      const locationChart = document.getElementById('location-pie-chart');
      if (locationChart) {
        // 既存のチャートがあれば破棄する
        const existingChart = Chart.getChart(locationChart);
        if (existingChart) {
          existingChart.destroy();
        }

        // データからパイチャートを作成
        const homeCount = parseInt('{{ default_data["在宅"]|length }}' || '0');
        const officeCount = parseInt('{{ default_data["出社"]|length }}' || '0');
        const tripCount = parseInt('{{ default_data["出張"]|length }}' || '0');

        // データがある場合のみグラフを表示
        if (homeCount > 0 || officeCount > 0 || tripCount > 0) {
          new Chart(locationChart, {
            type: 'pie',
            data: {
              labels: ['在宅', '出社', '出張'],
              datasets: [{
                data: [homeCount, officeCount, tripCount],
                backgroundColor: [
                  'rgba(75, 192, 192, 0.7)',
                  'rgba(54, 162, 235, 0.7)',
                  'rgba(255, 206, 86, 0.7)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom'
                },
                tooltip: {
                  enabled: true
                }
              }
            }
          });
        }
      }
    });
  </script>

</body>

</html>