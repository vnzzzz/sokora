<!DOCTYPE html>
<html lang="ja" x-data>

<head>
  <meta charset="utf-8">
  <title>sokora</title>
  <!-- ミニファイドJSはDockerfileで取得して/static/jsに配置 -->
  <script src="/static/js/alpine.min.js" defer></script>
  <script src="/static/js/htmx.min.js"></script>
  <script src="/static/js/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>

  <header>
    <h1>Sokora</h1>
    <button hx-get="/api/csv/export" hx-target="#detail-area">CSVダウンロード</button>
    <button @click="$store.importModal.toggle()">CSVアップロード</button>
    <div x-data="{ showImport: false }" x-show="$store.importModal.open" style="display:none;">
      <form hx-post="/api/csv/import" hx-encoding="multipart/form-data" hx-target="#detail-area">
        <input type="file" name="file">
        <button type="submit">インポート</button>
        <button type="button" @click="$store.importModal.toggle()">キャンセル</button>
      </form>
    </div>
  </header>

  <main>
    <!-- カレンダー領域 -->
    <div id="calendar-area" hx-get="/api/calendar" hx-trigger="load" hx-target="#calendar-area">
      <!-- 初期ロード時に /api/calendar を呼び出し、ここに差し込み -->
    </div>

    <!-- 日別・ユーザー別の詳細表示領域 -->
    <div id="detail-area">
      <!-- デフォルトで今日のデータを表示 -->
      {% if default_day and default_data %}
      <section>
        <h3>{{ default_day }} の詳細</h3>

        {% if default_data["在宅"]|length == 0 and default_data["出社"]|length == 0 and default_data["出張"]|length == 0 %}
        <div class="no-data-message">
          この日のデータはありません
        </div>
        {% else %}
        <!-- 勤務場所データと円グラフ、社員リスト -->
        <div class="day-detail-container">
          <!-- 左側：グラフエリア -->
          <div class="day-chart-area">
            <div class="location-chart-container">
              <canvas id="location-pie-chart"></canvas>
            </div>
          </div>

          <!-- 右側：社員リストエリア -->
          <div class="day-user-list-area">
            <div class="user-lists">
              <div class="user-category">
                <h4>在宅</h4>
                <ul>
                  {% for user in default_data["在宅"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
              </div>

              <div class="user-category">
                <h4>出社</h4>
                <ul>
                  {% for user in default_data["出社"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
              </div>

              <div class="user-category">
                <h4>出張</h4>
                <ul>
                  {% for user in default_data["出張"] %}
                  <li hx-get="/api/user/{{ user }}" hx-target="#detail-area">{{ user }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </section>
      {% endif %}
    </div>
  </main>

  <script>
    // Alpine.jsのグローバルストア
    document.addEventListener('alpine:init', () => {
      Alpine.store('importModal', {
        open: false,
        toggle() {
          this.open = !this.open;
        }
      });
    });

    // Chart.jsプラグイン登録
    Chart.register(ChartDataLabels);

    // Chart.jsヘルパー関数
    const chartColors = [
      'rgba(75, 192, 192, 0.7)', // 在宅
      'rgba(54, 162, 235, 0.7)', // 出社
      'rgba(255, 206, 86, 0.7)'  // 出張
    ];

    function createPieChart(canvasId, homeCount, officeCount, tripCount, showLegend = true) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      // 既存のチャートがあれば破棄する
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      // データがある場合のみグラフを表示
      if (homeCount > 0 || officeCount > 0 || tripCount > 0) {
        new Chart(canvas, {
          type: 'pie',
          data: {
            labels: ['在宅', '出社', '出張'],
            datasets: [{
              data: [homeCount, officeCount, tripCount],
              backgroundColor: chartColors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: true
              },
              datalabels: {
                formatter: (value, ctx) => {
                  const label = ctx.chart.data.labels[ctx.dataIndex];
                  return `${label}\n${value}名`;
                },
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 14
                },
                align: 'center',
                anchor: 'center'
              }
            }
          }
        });
      }
    }

    // HTMXイベントリスナー
    document.addEventListener('htmx:afterSwap', function (event) {
      // カレンダーエリアが更新されたときの処理
      if (event.detail.target.id === 'calendar-area') {
        // カレンダー内のチャートを再初期化
      }

      // 詳細エリアが更新されたときのチャート描画
      if (event.detail.target.id === 'detail-area') {
        const locationChart = document.getElementById('location-pie-chart');
        if (locationChart) {
          // データを直接取得
          const containers = document.querySelectorAll('.user-category');
          if (containers.length >= 3) {
            const homeCount = containers[0].querySelectorAll('li').length;
            const officeCount = containers[1].querySelectorAll('li').length;
            const tripCount = containers[2].querySelectorAll('li').length;

            createPieChart('location-pie-chart', homeCount, officeCount, tripCount, true);
          }
        }
      }
    });

    // 初期表示時のチャート描画
    document.addEventListener('DOMContentLoaded', function () {
      const homeCount = parseInt('{{ default_data["在宅"]|length }}' || '0');
      const officeCount = parseInt('{{ default_data["出社"]|length }}' || '0');
      const tripCount = parseInt('{{ default_data["出張"]|length }}' || '0');

      createPieChart('location-pie-chart', homeCount, officeCount, tripCount, true);
    });
  </script>

</body>

</html>