<!DOCTYPE html>
<html lang="ja" x-data class="bg-base-100">

{% set title_text = username ~ " の勤怠入力 - Sokora" %}
{% include "components/head.html" %}

<body class="min-h-screen bg-base-100">
  <!-- テーマ切り替えボタン -->
  {% include "components/theme_switcher.html" %}

  <!-- ヘッダー -->
  <header class="navbar bg-base-200 shadow-sm px-4 py-2">
    <div class="navbar-start">
      <a href="/" class="text-xl font-bold">Sokora</a>
    </div>
    <div class="navbar-end space-x-2">
      <a href="/attendance" class="btn btn-sm btn-accent">社員一覧へ戻る</a>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container mx-auto p-4 space-y-6">
    <div class="card bg-base-200 shadow-sm p-4">
      <div class="flex items-center gap-2 mb-4">
        <h3 class="text-lg font-bold">{{ username }} の勤怠入力</h3>
      </div>

      <div class="mb-4">
        <p class="text-sm opacity-70">日付をクリックして勤務場所を設定してください。</p>
      </div>

      <!-- カレンダー形式の表示 -->
      <div class="overflow-x-auto">
        <!-- 曜日ヘッダー -->
        <div class="grid grid-cols-7 gap-1 mb-2 text-center font-bold">
          {% set weekdays = ["日", "月", "火", "水", "木", "金", "土"] %}
          {% for day in weekdays %}
          <div class="p-1">{{ day }}</div>
          {% endfor %}
        </div>

        <!-- カレンダーグリッド -->
        <div class="grid grid-cols-7 gap-1">
          {% for week in calendar_data %}
          {% for day in week %}
          {% if day.date %}
          {% set has_data = day.date in user_dates %}
          {% set location = user_locations[day.date] if has_data else "" %}
          {% set style_class = location_styles[location] if location in location_styles else "" %}

          <div x-data="{ showModal: false, date: '{{ day.date }}', currentLocation: '{{ location }}' }" class="p-1 border rounded min-h-12 
                 {% if has_data %}{{ style_class.split(' ')[0] }}{% endif %}
                 text-center cursor-pointer
                 {% if day.is_today %}border-accent{% endif %}" @click="showModal = true">
            <div class="text-sm font-bold">{{ day.day }}</div>
            {% if has_data %}
            <div class="text-xs mt-1">
              <span class="{{ style_class.split(' ')[1] if style_class else '' }}">{{ location }}</span>
            </div>
            {% endif %}

            <!-- 勤務場所設定モーダル -->
            <div x-show="showModal" style="display:none;"
              class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
              @click.away="showModal = false">
              <div class="bg-base-100 p-6 rounded-lg shadow-xl max-w-md w-full" @click.stop>
                <h3 class="font-bold text-lg mb-4">{{ username }} - <span x-text="date"></span>の勤務場所設定</h3>
                <form action="/api/attendance/update" method="post" class="space-y-4">
                  <input type="hidden" name="username" value="{{ username }}">
                  <input type="hidden" name="date" x-bind:value="date">

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">勤務場所</span>
                    </label>
                    <select name="location" class="select select-bordered w-full" x-model="currentLocation">
                      <option value="">-- 選択してください --</option>
                      {% for loc_type in location_types %}
                      <option value="{{ loc_type }}">{{ loc_type }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="flex justify-end space-x-2">
                    <button type="button" class="btn btn-outline" @click="showModal = false">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% else %}
          <div class="p-1 border rounded bg-base-200/30 min-h-12"></div>
          {% endif %}
          {% endfor %}
          {% endfor %}
        </div>
      </div>

      <!-- 月移動ボタン -->
      <div class="flex justify-center mt-4 space-x-2">
        <a href="/attendance/edit/{{ username }}?month={{ prev_month }}" class="btn btn-sm btn-outline">＜前月</a>
        <a href="/attendance/edit/{{ username }}" class="btn btn-sm">今月</a>
        <a href="/attendance/edit/{{ username }}?month={{ next_month }}" class="btn btn-sm btn-outline">翌月＞</a>
      </div>
    </div>
  </main>

  <!-- JavaScript -->
  <script>
    // ページ読み込み時の初期化処理
    document.addEventListener('DOMContentLoaded', function () {
      // ここに必要な初期化コードを追加
    });
  </script>
</body>

</html>