# テスト戦略

本ドキュメントは `rules/development.md` とセットで参照し、TDD を徹底するためのガイドラインを示します。

## TDD ルール
- 期待するユーザー挙動を先にテスト化し、失敗を確認してから実装を開始する。
- テストをグリーンにする最小限の実装を入れた後、必要に応じてリファクタ・追加テストで補強する。
- スナップショットやゴールデン更新は意図をコメントに残し、不要な変更を含めない。
- テストが無い機能差分をレビューに出さない。

## レイヤー別の観点
- **API** (`app/tests/routers/api/v1/`): FastAPI ルーターを対象に、ステータスコード・レスポンス JSON・バリデーションエラー・権限境界を検証する。サービス層はモックしても良い。
- **ページ** (`app/tests/routers/pages/`): HTML や部分テンプレートの断面を検証し、HTMX のスワップ対象や必要な属性が含まれるかを確認する。
- **サービス** (`app/tests/services/`): ユースケースの境界条件や集計ロジックをテーブルドリブンでカバーする。DB はフィクスチャでセットアップする。
- **CRUD / utils** (`app/tests/crud/`, `app/tests/utils/`): SQLAlchemy / ユーティリティの単体テスト。制約違反や例外系も明示する。
- **E2E** (`app/tests/e2e/`): pytest-playwright でブラウザ操作を行い、主要フローを通して UI / API の連携を検証する。`http://localhost:8000` でアプリが起動している前提。

## 実行フロー
- 標準: `./scripts/testing/run_test.sh`
  - 事前チェックとデータクリーンアップを実施。
  - API/ユニットテストを `pytest` で実行。
  - E2E を続けて実行（必要に応じて事前に `make run` などでサーバを起動）。
  - 事後に DB の状態を確認し、必要ならクリーンアップ。
- 影響範囲が限定される場合は対象ディレクトリの pytest だけを回し、最終的に上記スクリプトで一式確認する。

## フィクスチャ / データ
- テストデータは pytest フィクスチャで明示し、共有データを汚さない。`app/tests/utils/data_cleanup.py` を活用する。
- SQLite の一意制約や FK を前提にしたケースでは、制約に引っかかるデータを明確に記述する。
- 外部依存はモックし、時間依存は固定クロックを注入する。

## チェックリスト
- [ ] 受け入れレベルのテストを先に失敗させた。
- [ ] サービス・CRUD・ユーティリティの境界条件を追加でテストした。
- [ ] ローカルで `./scripts/testing/run_test.sh` もしくは相当の pytest を通した。
- [ ] テストデータをクリーンアップし、DB に不要な差分を残していない。

テストは仕様の一次情報源として扱い、挙動変更時は必ず期待値をテストで表現してください。
